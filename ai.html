<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (V2 - Debug Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .markdown-body { color: #374151; line-height: 1.7; }
        .markdown-body pre { background: #1f2937; color: #e5e7eb; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        .markdown-body code { font-family: monospace; background: #e5e7eb; color: #c026d3; padding: 0.2em 0.4em; border-radius: 3px; }
        .markdown-body pre code { background: transparent; color: inherit; padding: 0; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-4 bg-gray-100">

    <div class="w-full max-w-4xl h-[90vh] flex flex-col bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
        
        <!-- Header -->
        <div class="bg-blue-600 p-4 text-white flex justify-between items-center shadow-md z-10">
            <h1 class="text-xl font-bold flex items-center gap-2">ü§ñ AI Assistant</h1>
            <div id="connectionStatus" class="text-xs bg-blue-500 px-3 py-1 rounded-full animate-pulse">Checking...</div>
        </div>

        <!-- Chat Area -->
        <div class="flex-1 bg-gray-50 p-6 overflow-y-auto relative flex flex-col gap-4" id="chatContainer">
            <div class="self-start bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-gray-200 max-w-[85%]">
                <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö?</p>
            </div>
        </div>

        <!-- Input Area -->
        <div class="bg-white p-4 border-t border-gray-200 z-20">
            <div class="relative flex gap-2">
                <textarea id="promptInput" class="w-full bg-gray-100 p-3 rounded-xl border focus:ring-2 focus:ring-blue-500 outline-none resize-none" rows="1" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°..."></textarea>
                <button onclick="sendRequest()" id="sendBtn" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-xl shadow-lg transition-all">‡∏™‡πà‡∏á</button>
            </div>
            <div id="debugInfo" class="text-xs text-red-500 mt-2 hidden text-center"></div>
        </div>
    </div>

    <script>
        // üü¢ URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ú‡∏°‡πÉ‡∏™‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß)
        const N8N_WEBHOOK_URL = "https://n8n.srv1265116.hstgr.cloud/webhook/chat"; 

        async function sendRequest() {
            const promptInput = document.getElementById('promptInput');
            const chatContainer = document.getElementById('chatContainer');
            const sendBtn = document.getElementById('sendBtn');
            const debugInfo = document.getElementById('debugInfo');
            const message = promptInput.value.trim();

            if (!message) return;

            appendMessage(message, 'user');
            promptInput.value = '';
            
            // Loading
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading';
            loadingDiv.className = 'self-start bg-white p-4 rounded-2xl rounded-tl-none shadow-sm flex gap-2 items-center';
            loadingDiv.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div><span class="text-sm text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...</span>';
            chatContainer.appendChild(loadingDiv);
            scrollToBottom();
            
            sendBtn.disabled = true;
            debugInfo.classList.add('hidden');

            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });

                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const data = await response.json();
                const aiText = data.text || data.output || data.reply || JSON.stringify(data);
                
                document.getElementById('loading').remove();
                appendMessage(aiText, 'ai');

            } catch (error) {
                console.error(error);
                document.getElementById('loading').remove();
                
                // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Error ‡πÅ‡∏ö‡∏ö‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
                let errorMsg = `‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${error.message}`;
                if (error.message.includes('Failed to fetch')) {
                    errorMsg += `<br><br><strong>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:</strong><br>
                    1. ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î CORS ‡∏ó‡∏µ‡πà Node <b>Webhook (Start)</b> ‡πÉ‡∏ô n8n<br>
                    2. ‡∏•‡∏∑‡∏°‡∏Å‡∏î <b>Activate</b> (‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô n8n)<br>
                    3. Browser ‡∏ö‡∏•‡πá‡∏≠‡∏Å (‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î Console ‡∏Å‡∏î F12 ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)`;
                }
                appendMessage(errorMsg, 'error');
            } finally {
                sendBtn.disabled = false;
            }
        }

        function appendMessage(text, type) {
            const div = document.createElement('div');
            div.className = type === 'user' 
                ? "self-end bg-blue-600 text-white p-4 rounded-2xl rounded-tr-none shadow-md max-w-[85%] markdown-body"
                : `self-start bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-gray-200 max-w-[85%] markdown-body ${type === 'error' ? 'border-red-500 bg-red-50 text-red-600' : ''}`;
            
            if (type === 'user') div.style.color = 'white';
            div.innerHTML = marked.parse(text);
            document.getElementById('chatContainer').appendChild(div);
            div.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
            scrollToBottom();
        }

        function scrollToBottom() {
            const c = document.getElementById('chatContainer');
            c.scrollTop = c.scrollHeight;
        }

        document.getElementById('promptInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendRequest(); }
        });
        
        // Check Status ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
        document.getElementById('connectionStatus').innerText = "Ready";
        document.getElementById('connectionStatus').className = "text-xs bg-green-500 px-3 py-1 rounded-full text-white";
    </script>
</body>
</html>
